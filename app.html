<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8" />
  <title>LockAllGroups</title>
  <script src="https://miro.com/app/static/sdk/v2/miro.js"></script>
</head>
<body>
<script>
(async () => {
  // –í –Ω–µ–∫–æ—Ç–æ—Ä—ã—Ö –æ–∫—Ä—É–∂–µ–Ω–∏—è—Ö onReady –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω ‚Äî –ø—Ä–æ—Å—Ç–æ –Ω–µ –ø–∞–¥–∞–µ–º
  if (miro.onReady) { try { await miro.onReady(); } catch (e) {} }

  try {
    // 1) –ù–∞—Ö–æ–¥–∏–º –í–°–ï –≥—Ä—É–ø–ø—ã –Ω–∞ –¥–æ—Å–∫–µ (–∏–º–µ–Ω–Ω–æ –≥—Ä—É–ø–ø—ã, –Ω–µ –ø—Ä–æ—Å—Ç–æ –≤—ã–¥–µ–ª–µ–Ω–∏–µ)
    const groups = await miro.board.get({ type: 'group' }); // v2 API
    if (!groups.length) {
      await miro.board.notifications.showInfo('–ì—Ä—É–ø–ø –Ω–∞ –¥–æ—Å–∫–µ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ');
      return;
    }

    let lockedGroups = 0;
    let lockedItems = 0;

    for (const group of groups) {
      // –ü–æ–ø—ã—Ç–∫–∞ 1: –∑–∞–ª–æ—á–∏—Ç—å —Å–∞–º—É –≥—Ä—É–ø–ø—É (–µ—Å–ª–∏ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç—Å—è)
      let groupLocked = false;
      try {
        group.locked = true;
        await group.sync();              // v2: –∏–∑–º–µ–Ω–µ–Ω–∏–µ –ø—Ä–∏–º–µ–Ω—è–µ—Ç—Å—è –∑–¥–µ—Å—å
        groupLocked = true;
        lockedGroups += 1;
      } catch (e) {
        // –ï—Å–ª–∏ SDK –Ω–µ –¥–∞–ª –∑–∞–ª–æ—á–∏—Ç—å –≥—Ä—É–ø–ø—É –Ω–∞–ø—Ä—è–º—É—é ‚Äî –ª–æ—á–∏–º –µ—ë —Å–æ–¥–µ—Ä–∂–∏–º–æ–µ
        const children = await group.getItems(); // –º–µ—Ç–æ–¥ –≥—Ä—É–ø–ø—ã –∏–∑ v2
        for (const item of children) {
          try {
            item.locked = true;
            await item.sync();
            lockedItems += 1;
          } catch (inner) {
            console.warn('–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–ª–æ—á–∏—Ç—å —ç–ª–µ–º–µ–Ω—Ç', item.id, inner);
          }
        }
      }
    }

    const msg = lockedGroups
      ? `üîí –ó–∞–ª–æ—á–µ–Ω–æ –≥—Ä—É–ø–ø: ${lockedGroups} (–∞ —Ç–∞–∫–∂–µ —ç–ª–µ–º–µ–Ω—Ç–æ–≤ –≤–Ω—É—Ç—Ä–∏: ${lockedItems})`
      : `üîí –ó–∞–ª–æ—á–µ–Ω–æ —ç–ª–µ–º–µ–Ω—Ç–æ–≤ –≤–Ω—É—Ç—Ä–∏ –≥—Ä—É–ø–ø: ${lockedItems}`;
    await miro.board.notifications.showInfo(msg);
  } catch (err) {
    console.error(err);
    // –ü–æ–∫–∞–∂–µ–º –∫—Ä–∞—Å–∏–≤—É—é –æ—à–∏–±–∫—É –≤ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–µ Miro
    if (miro.board?.notifications?.showError) {
      await miro.board.notifications.showError('–û—à–∏–±–∫–∞ –ø—Ä–∏ –±–ª–æ–∫–∏—Ä–æ–≤–∫–µ –≥—Ä—É–ø–ø: ' + (err?.message || err));
    } else {
      alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ –±–ª–æ–∫–∏—Ä–æ–≤–∫–µ –≥—Ä—É–ø–ø: ' + (err?.message || err));
    }
  }
})();
</script>
</body>
</html>
